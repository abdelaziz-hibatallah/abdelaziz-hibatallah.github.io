<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Ego | Security Project</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <style>
        :root {
            --primary-color: #fff;
            --bg-color: #000;
            --container-bg: #111;
            --accent-red: #ff3b30;
        }
        body {
            background-color: var(--bg-color);
            color: #ccc;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
        }
        .container {
            width: 90%;
            max-width: 450px;
            background: var(--container-bg);
            padding: 25px;
            border: 1px solid #333;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.7);
        }
        h1 { margin-bottom: 20px; letter-spacing: 2px; color: var(--primary-color); font-weight: 300;}
        
        input.auth-input {
            background: #1a1a1a;
            border: 1px solid #444;
            color: var(--primary-color);
            padding: 15px;
            margin: 10px 0;
            width: 85%;
            text-align: center;
            border-radius: 8px;
            outline: none;
            font-size: 16px;
            transition: 0.3s;
        }
        input.auth-input:focus { border-color: #777; background: #222; }
        
        .main-btn {
            background: var(--primary-color);
            color: #000;
            border: none;
            padding: 15px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 20px;
            width: 92%;
            border-radius: 8px;
            font-size: 16px;
            transition: 0.2s;
        }
        .main-btn:hover { background: #ddd; }

        /* شات */
        #chat-interface { display: none; height: 92vh; flex-direction: column; padding: 15px; }
        #room-header { 
            font-size:0.9em; color:#888; padding-bottom: 10px; border-bottom: 1px solid #222; margin-bottom: 10px;
            display: flex; justify-content: space-between; align-items: center;
        }
        #messages { flex-grow: 1; overflow-y: auto; padding-right: 5px; margin-bottom: 15px; text-align: left; }
        
        .msg { margin-bottom: 15px; padding: 10px; background: #1a1a1a; border-radius: 8px; border-left: 3px solid #333; }
        .meta { font-size: 0.7em; color: #666; margin-bottom: 5px; display: flex; justify-content: space-between;}
        .sender-name { font-weight: bold; color: #999; }
        .text { font-size: 1.05em; color: #eee; line-height: 1.4; }
        audio { width: 100%; height: 32px; margin-top: 8px; border-radius: 4px; }

        /* منطقة الإدخال */
        .input-area { display: flex; align-items: center; background: #1a1a1a; padding: 8px; border-radius: 25px; border: 1px solid #333; }
        #msg-input { flex-grow: 1; background: transparent; border: none; color: #fff; padding: 10px; outline: none; font-size: 16px; }
        
        .mic-btn {
            background: #333; color: #fff; border: none; width: 45px; height: 45px; border-radius: 50%;
            display: flex; justify-content: center; align-items: center; cursor: pointer; margin-left: 8px; transition: 0.3s;
        }
        .mic-btn svg { width: 24px; height: 24px; fill: currentColor; }
        .mic-btn.recording { background: var(--accent-red); animation: pulse-red 1.5s infinite; }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(255, 59, 48, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(255, 59, 48, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 59, 48, 0); } }

        .send-btn-icon { background: transparent; border: none; color: var(--primary-color); cursor: pointer; padding: 10px; margin-left: 5px; }
        .send-btn-icon svg { width: 24px; height: 24px; fill: currentColor; transform: rotate(-45deg); margin-top:3px;}
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 3px; }
    </style>
</head>
<body>

    <div id="auth-interface" class="container">
        <h1>THE EGO <span style="font-size:0.5em; display:block; color:#555; margin-top:5px;">CYBER SECURITY PROJECT</span></h1>
        <p id="status-msg" style="color:var(--accent-red); font-size:0.9em; min-height: 1.2em;"></p>

        <input type="text" id="username" class="auth-input" placeholder="Pseudo (Nom Utilisateur)">
        <input type="password" id="user-pass" class="auth-input" maxlength="5" placeholder="Mot de passe (3-5 chiffres)">
        <div style="margin: 20px 0; height: 1px; background: #222;"></div>
        <input type="number" id="room-code" class="auth-input" placeholder="Code Chambre (4-9 chiffres)">
        
        <button class="main-btn" onclick="handleLoginAndJoin()">CONNEXION / CRÉER</button>
    </div>

    <div id="chat-interface" class="container">
        <div id="room-header">
            <span>ROOM: <strong id="room-display" style="color:#fff"></strong></span>
            <button onclick="location.reload()" style="background:transparent; border:1px solid #333; color:#666; padding: 5px 10px; border-radius: 4px; cursor:pointer; font-size:0.8em;">QUITTER</button>
        </div>
        <div id="messages"></div>
        <div class="input-area">
            <button id="record-btn" class="mic-btn" onmousedown="startRecording()" onmouseup="stopRecording()" ontouchstart="startRecording()" ontouchend="stopRecording()">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.91-3c-.49 0-.9.36-.98.85C16.52 14.2 14.47 16 12 16s-4.52-1.8-4.93-4.15c-.08-.49-.49-.85-.98-.85-.61 0-1.09.54-1 1.14.49 3 2.89 5.35 5.91 5.78V20c0 .55.45 1 1 1s1-.45 1-1v-2.08c3.02-.43 5.42-2.78 5.91-5.78.1-.6-.39-1.14-1-1.14z"/></svg>
            </button>
            <input type="text" id="msg-input" placeholder="Message..." onkeypress="handleEnter(event)">
            <button class="send-btn-icon" onclick="sendMessage()">
                 <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
            </button>
        </div>
    </div>

    <script>
        // --- 1. إعدادات Firebase ---
        const firebaseConfig = {
            apiKey: "AIzaSyBwRtHgM5cBTxci9ffzMOPp9POTTy-PbWE",
            authDomain: "theegochat.firebaseapp.com",
            databaseURL: "https://theegochat-default-rtdb.firebaseio.com", 
            projectId: "theegochat",
            storageBucket: "theegochat.firebasestorage.app",
            messagingSender
